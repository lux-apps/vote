{"version":3,"file":"index.js","sources":["../src/miniflarePlugin.ts","../src/utils.ts","../src/swcPlugin.ts","../src/index.ts"],"sourcesContent":["import { ResolvedCloudflareSpaConfig } from './CloudflareSpaConfig';\nimport { unstable_dev } from 'wrangler';\nimport type { PluginOption } from 'vite';\n\nexport const miniflarePlugin = (config: ResolvedCloudflareSpaConfig) => {\n  const { functionEntrypoint, wranglerConfig, allowedApiPaths } = config;\n\n  // force wrangler settings that are required for function HMR to work\n  if (!wranglerConfig.experimental) wranglerConfig.experimental = {};\n  wranglerConfig.experimental.liveReload = true;\n  wranglerConfig.experimental.testMode = false;\n\n  return {\n    name: 'vite-plugin-wrangler-spa:miniflare',\n    apply: 'serve',\n    configResolved: async (viteConfig) => {\n      viteConfig.server.proxy = allowedApiPaths.reduce(\n        (acc, curr) => ({ ...acc, [curr]: `http://127.0.0.1:${wranglerConfig.port}` }),\n        {}\n      );\n    },\n    configureServer: async (devServer) => {\n      return async () => {\n        const wranglerDevServer = await unstable_dev(functionEntrypoint, wranglerConfig);\n        devServer.httpServer?.on('close', async () => await wranglerDevServer.stop());\n      };\n    },\n    handleHotUpdate: async (ctx) => {\n      if (ctx.file.includes(functionEntrypoint.split('/')[0]))\n        ctx.server.hot.send({\n          type: 'custom',\n          event: 'function-update',\n          data: { file: ctx.file },\n        });\n    },\n    transformIndexHtml: {\n      order: 'pre',\n      handler: () => [\n        {\n          tag: 'script',\n          attrs: { type: 'module' },\n          children: browserHmrNotification,\n        },\n      ],\n    },\n  } as PluginOption;\n};\n\nconst browserHmrNotification = `\nif (import.meta.hot) {\n  let outputColor = \"color:cyan; font-weight:bold;\"\n  import.meta.hot.on('function-update', (data) => {\n    console.log(\\`%c ðŸ”¥ Cloudflare Pages Function - update detected in file: '\\${data.file}'\\`, outputColor);\n    location.reload(true);\n  }); \n}`;\n","import { ResolvedCloudflareSpaConfig } from './CloudflareSpaConfig';\nimport { UserConfig } from 'vite';\nimport { builtinModules } from 'node:module';\n\nexport const getViteConfig = ({ functionEntrypoint, external }: ResolvedCloudflareSpaConfig) => {\n  return {\n    ssr: {\n      external,\n      noExternal: true,\n    },\n    esbuild: false, // we use SWC to build\n    build: {\n      sourcemap: true, // always include sourcemaps\n      rollupOptions: {\n        external: [...builtinModules, /^node:/],\n        input: functionEntrypoint,\n        preserveEntrySignatures: 'allow-extension',\n        output: { entryFileNames: '_worker.js' },\n      },\n      emptyOutDir: false,\n      ssr: true,\n    },\n  } as UserConfig;\n};\n","import { ResolvedCloudflareSpaConfig } from './CloudflareSpaConfig';\nimport { getViteConfig } from './utils';\nimport { transform as swcTransform } from '@swc/core';\nimport { writeFile } from 'node:fs';\nimport type { PluginOption } from 'vite';\n\nexport const swcPlugin = (config: ResolvedCloudflareSpaConfig) => {\n  const { allowedApiPaths, excludedApiPaths, swcConfig } = config;\n\n  return {\n    name: 'vite-plugin-wrangler-spa:swc',\n    apply: (_, { command, mode }) => command === 'build' && mode === 'page-function',\n    config: () => getViteConfig(config),\n    transform: (code) => swcTransform(code, swcConfig),\n    writeBundle: async () =>\n      await writeFile(\n        'dist/_routes.json',\n        JSON.stringify(\n          {\n            version: 1,\n            include: allowedApiPaths.map((x) => x.replace('^', '')),\n            exclude: excludedApiPaths.map((x) => x.replace('^', '')),\n          },\n          null,\n          2\n        ),\n        (err) => (err ? console.error(err.message) : null)\n      ),\n  } as PluginOption;\n};\n","import { CloudflareSpaConfig, ResolvedCloudflareSpaConfig } from './CloudflareSpaConfig';\nimport { miniflarePlugin } from './miniflarePlugin';\nimport { swcPlugin } from './swcPlugin';\n\nconst defaultCloudflareSpaConfig: ResolvedCloudflareSpaConfig = {\n  allowedApiPaths: ['^/api/*'],\n  excludedApiPaths: [],\n  functionEntrypoint: 'functions/index.ts',\n  external: [],\n  wranglerConfig: {\n    port: 55554,\n    logLevel: 'log',\n    experimental: {\n      disableExperimentalWarning: true, //disable because it's annoying\n    },\n  },\n  wranglerConfigPath: 'wrangler.toml',\n  swcConfig: {\n    minify: true,\n    sourceMaps: true,\n    inlineSourcesContent: true,\n    jsc: {\n      target: 'esnext',\n      parser: {\n        tsx: true,\n        syntax: 'typescript',\n        decorators: true,\n      },\n      transform: {\n        decoratorMetadata: true,\n        legacyDecorator: true,\n      },\n      minify: {\n        compress: true,\n        mangle: true,\n      },\n      loose: true,\n    },\n  },\n};\n\nexport const viteWranglerSpa = (config: CloudflareSpaConfig = defaultCloudflareSpaConfig) => {\n  const runtimeConfig: ResolvedCloudflareSpaConfig = {\n    ...defaultCloudflareSpaConfig,\n    ...config,\n  };\n\n  return [miniflarePlugin(runtimeConfig), swcPlugin(runtimeConfig)];\n};\n"],"names":["swcTransform"],"mappings":"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"}